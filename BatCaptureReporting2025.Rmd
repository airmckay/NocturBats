---
title: "BatCaptureReporting2025"
output: html_document
date: "2026-02-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Consolidate Bat box and mist net survey capture data from 2024 and 2023
Report findings to Miljødirektoratet and to Artsobservasjoner


## Set up the work space
```{r}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(tidy = "styler")

#### Load libraries ####
library(data.table)
library(tidyverse)
library(beepr)
library(lubridate)
library(purrr)
library(renv)
library(stringr)
library(janitor)
library(readr)
library(readxl)
library(raster)
library(rgdal)
library(rgeos)
library(mapview)
library(sf)
library(sp)
library(maps)
library(leaflet)
library(randomcoloR)
library(wesanderson)
library(leaflegend)
library(osmdata)
library(MetBrewer)
library(colorBlindness)
library(colorblindcheck)
library(ggmap)
library(maptools)
library(spatstat)

## Set up output directory

output <-"C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/Noctur/Analyses/Outputs/Reed" # where you want to save your data

file.name <- "CleanBatCaptureData2025"

todays_date <- Sys.Date()
 

dir.name <- str_c(output,"/", file.name, "_", todays_date)
dir.name
 
output_today <- dir.name
output_today

dir.create(output_today)
output_today
# "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/Noctur/Analyses/Outputs/Reed/CleanBatCaptureData2025_2026-02-12"

cap <- read_excel("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/Noctur/Data/BatBoxes/BatCaptures/2025/Survery123_BatCaptures2025.xlsx")
# 145 obs 35

nets <- read_excel("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/Noctur/Data/MistNetting/S123_MistNetSites_2025.xlsx")

("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/Noctur/Data/MistNetting/S123_MistNetSites_2025.xlsx")

boxes <- read_excel("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/Noctur/Data/BatBoxes/SiteInformation/2024/Uncleaned Overview/Bat Box Site Overview v3.xlsx")
# 69 obs 20

sboxes <- read_csv("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/Noctur/Data/BatBoxes/SiteInformation/2024/Survery123/survey123_BatBoxOverview_2024_v6.csv")
# 81 obs 28

```

## House keeping
Subset the datasets to only include the relevant columns 
```{r}
bcap <- cap %>% 
  dplyr::select('Date and time',
         'Crew member filling in form',
         'Other - Crew member filling in form',
         'Crew member processing bat',
    'Box ID', 'Bat ID', 
    'Mist netting Site',
    'Mist net Name', 
    'Sex', 
    'Reproductive status: Male', 
    'Reproductive status: Female', 
                          'Right forearm length (mm)', "Weight (g)", 
                          "Band number", "Bat species", "Age") %>% 
  rename(DateTime = 'Date and time',
         BBid = 'Box ID',
         MN_Site = 'Mist netting Site',
         Net = 'Mist net Name', 
         BatID  = 'Bat ID',
         RFA = 'Right forearm length (mm)',
         Weight = "Weight (g)",
         BandNumber = "Band number", 
         Species = "Bat species",
         Crew1 = 'Crew member filling in form', 
         Crew2 = 'Other - Crew member filling in form',
         Crew3 = 'Crew member processing bat') %>% 
  mutate(BBid = factor(BBid), 
         MN_Site = factor(MN_Site),
         Sex = factor(Sex), 
         Species = factor(Species),
         Age= factor(Age), 
         Crew = paste0(Crew1, ",",
         Crew2, ",",
         Crew3),
         Date = as.Date(DateTime)) %>% 
  dplyr::select(-c(Crew1, Crew2, Crew3)) 

summary(bcap)
# [1] "Lista fyr"            "MO"                   "NMBU Sandnes- garden" "NMBU Sandnes-garden"  "SF"                  
# [6] "Søndre Frøyland"      "SØNDRE FRØYLAND"    


## Create a shorthand code for the different mist net sites 
bcap <- bcap %>% 
  mutate(MN = factor(case_when(
  MN_Site == "Lista fyr" ~ "MN-LI",
  MN_Site == "MO" ~ "MN-MO", 
  MN_Site == "NMBU Sandnes- garden" ~ "MN-NM", 
  MN_Site == "NMBU Sandnes-garden" ~ "MN-NM", 
  MN_Site == "Søndre Frøyland" ~ "MN-SO", 
  MN_Site == "SØNDRE FRØYLAND" ~ "MN-SO",
  MN_Site == "SF" ~ "MN-SO", 
  MN_Site == "NA" ~  "NA"))) 

summary(bcap$MN)
levels(bcap$MN_Site)

## Make new columns which create a more unique bat ID and which make sex and repro separate columns
## Create  a new column for swollen buccal glands

  temp1 <- bcap %>% filter(BBid != "NA") %>% 
    mutate(Bid = factor(paste0(BBid, "_",Date, "_", BatID))) 
  # 135 cases, 10 lost - good! 
# Now bats captured at mist net sites have an NA - so fix this so there is a clean unique bat ID for each captured bat ## Filter for only those cases where there is an NA in Bid
 temp2 <- bcap %>% filter(MN != "NA") %>% 
    mutate(Bid = factor(paste0(MN, "_",Date, "_", BatID)))  
 head(temp2$Bid)
 
## Now re-combine these two temp objects 
bcap1 <- full_join(temp1, temp2)
dim(bcap1)
summary(bcap1) # good! 


## Now tidy the reproductive status  
bcap1$rep1 <- factor(gsub("Female:_", "", bcap1$'Reproductive status: Female')) 

bcap1$rep2 <- factor(gsub("Male:_", "", bcap1$'Reproductive status: Male')) 
bcap1$rep3 <- factor(gsub("Male_", "", bcap1$rep2)) 

## Right now there are two different columns for males and females, make 1 

summary(bcap1$Sex)
# Female   Male 
#     89     56


## Females first 
temp1 <- bcap1 %>% dplyr::filter(Sex == "Female") %>% droplevels()
# 89

## There is one female bat for which there is no reproductive status listed 
# I will assume that this bat was Non-reproductive, as is the most common outcome 
temp1 <- temp1 %>% mutate(Repro = factor(replace_na(rep1, "Non-reproductive"))) 
                      
levels(temp1$Repro)
# "Non-reproductive"                
#"Non-reproductive,Post_lactating"
# "Post_lactating"                 
# "Post_lactating,Non-reproductive"

## Now tidy these categories of reproduction status and remove extra repro columns 
temp1 <- temp1 %>% mutate(Repro = factor(case_when(
  Repro == "Non-reproductive" ~ "Non-reproductive", 
  Repro == "Non-reproductive,Post_lactating" ~ "Post-lactating",
  Repro == "Post_lactating" ~ "Post-lactating",
  Repro == "Post_lactating,Non-reproductive" ~ "Post-lactating"))) %>% 
  dplyr::select(-c(rep1, rep2, rep3, 'Reproductive status: Female', 'Reproductive status: Male'))

levels(temp1$Repro)
summary(temp1)
# "Non-reproductive" "Post-lactating"  - good!

## Make a buccal column for the ladies... 
## Females can also have swollen buccal glands but we did not record this very well in 2025 for females. 

temp1$buccal <- "No"
temp1$buccal <- factor(temp1$buccal)

## Now for males 
temp2 <- bcap1 %>% dplyr::filter(Sex == "Male") %>% droplevels()
temp2$Repro <- factor(temp2$rep3)
                      
levels(temp2$Repro)
# "1"               
# "2"               
# "2,Swollen_buccal"
# "3"                
# "3,Swollen_buccal" 
# "4"               
# "Swollen_buccal,2" 
# "Swollen_buccal,3"


## Create a buccal column 
temp2 <- temp2 %>% mutate(buccal = factor(case_when(
  str_detect(Repro, "Swollen_buccal") ~ "Yes", 
  TRUE ~ "No")))

summary(temp2$buccal)
 # No Yes 
 # 30  26 

## Remove the swollen buccal text for now 
temp2$Repro <- factor(gsub("Swollen_buccal", "",temp2$Repro)) 
temp2$Repro <- factor(gsub(",", "",temp2$Repro)) 
levels(temp2$Repro)
# "1" "2" "3" "4"

## Good! 

## Now tidy these categories of reproduction status and remove extra repro columns 
temp2 <- temp2 %>% mutate(Repro = factor(case_when(
    Repro == "1" ~ "Non-reproductive",
    Repro == "2" ~ "Testes enlarged, sperm production phase",
    Repro == "3" ~ "Testes enlarged and epididymis distended, sperm production and storage phase",
    Repro == "4" ~ "Tests regressed and epididymis distended, sperm storage phase",
    TRUE ~ Repro))) %>% 
  dplyr::select(-c(rep1, rep2, rep3, 'Reproductive status: Female', 'Reproductive status: Male'))

levels(temp2$Repro)
# [1] "Non-reproductive"                                                            
# [2] "Testes enlarged and epididymis distended, sperm production and storage phase"
# [3] "Testes enlarged, sperm production phase"                                     
# [4] "Tests regressed and epididymis distended, sperm storage phase"   - good!
summary(temp2)


## Now combine the two sexes and do last of the tidying 

bcap2 <- full_join(temp1, temp2)
bcap2 <- bcap2 %>% mutate(Net = factor(Net)) 
summary(bcap2)


## Fix the datetime 
bcap2$datetime <- as.POSIXct(bcap2$DateTime, format = "%m/%d/%Y %I:%M:%S %p", tz = "CET")
# 8/16/2024 9:18:00 AM
head(bcap2$datetime)

## This is two hours behind what is recorded in the datasheets
## Create a unique bat ID 
bcap3 <- bcap2 %>% 
  mutate(datetime = datetime + hours(2)) %>% 
  dplyr::select(-DateTime) %>% 
  mutate(Date = as.Date(datetime), 
         ubid = factor(paste0(Bid, "-", Date))) 


#  write.csv(bcap3, file = file.path(output_today, "cleaned_bat_box_captures_2025_simple_columns.csv"))
# 145 obs 18 vars 
# 12.02.2025

```


## Bat band data 
```{r}
## First get the bat band report out 
bands <- bcap3 %>% dplyr::filter(BandNumber != "NA") %>% droplevels()
dim(bands)
# 31 18

bands$BandNumber <- factor(bands$BandNumber)
summary(bands)

## There are only 7 locations where bats were banded this year. I have a short deadline for submitting our bat band data to Stavanger Museum so I will manaually clean the rest of this in excel and adapt it to the submission form that they use. 

write.csv(bands, file = file.path(output_today, "bandedbats_2025.csv")) 

```



## Now clean the bat box data
```{r}
# Clean the bat box data from the excel overview 
box1 <- boxes %>% 
  rename(Bid = 'box id',
         loc = location, 
         lat = latitude, 
         lon = longitude) %>%
  dplyr::select(Bid, loc, lat, lon) %>% 
           mutate(Bid = factor(Bid), 
                  loc = factor(loc),
                  lon = as.character(lon), 
                  lat = as.character(lat)) %>% 
  dplyr::filter(Bid != "BB-MO-081", 
                Bid != "BB-RA-096", 
                Bid != "BB-RE-007") %>% 
  droplevels()
levels(box1$Bid)

# clean the Survey 123 bat box data
sbox1 <- sboxes %>% 
  rename(Bid = 'Bat Box ID',
         loc = Location,
         lat = 'Latitude (N)',
         lon = 'Longitude (E)') %>% 
    dplyr::select(Bid, loc, lat, lon) %>% 
           mutate(Bid = factor(Bid), 
                  loc = factor(loc),
                  lat = as.character(lat))

## Now combine for all bat box location data
boxdf <- full_join(box1,sbox1) %>% rename(BBid = Bid) 
# 146 obs 4 vars



## Check for duplicate bat box info!! 

# test <- duplicated_rows_dplyr <- boxdf |>
#   group_by(BBid) |>
#   filter(n() > 1) |>
#   ungroup()

# Innitially found duplicates BB-MO-081, BB-RA-096, and BB-RE-007 - removed from the excel file df 
# (See above) 


## Clean the locality information category
levels(boxdf$loc)
#  [1] "Bjarne"                   "Mosvatnet"                "Raulemyra"               
#  [4] "Rennesøy"                 "Revehamn"                 "Grødeim (GR)"            
#  [7] "Hornesvatnet (HO)"        "Kjosavik (KJ)"            "Litla Stokkavatnet (LS)_"
# [10] "Lædre (LA)"               "Raulemyra (RA)"           "Rennesøy (RE)"           
# [13] "�\u0086grehaug (AE)"   

boxdf1 <- boxdf %>% mutate(
  Locality = factor(case_when(
  loc %in% "Bjarne" ~ "Bjarne",
  str_detect(loc, "Mosvatnet") ~ "Mosvatnet", 
  str_detect(loc, "(GR)") ~ "Grodeim", 
  str_detect(loc, "Hornesvatnet") ~ "Hornesvatnet", 
  str_detect(loc, "Kjosavik") ~ "Kjosavik",
  str_detect(loc, "(LA)") ~ "Laedre", 
  str_detect(loc, "Raulemyra")  ~ "Raulemyra", 
  str_detect(loc, "Rennes") ~ "Rennesoy", 
  loc %in% "Revehamn" ~ "Revehamn",
  str_detect(loc, "(AE)")~ "Aegrehaug", 
  str_detect(BBid, "BB-LS") ~ "Litla Stokkavatnet" 
    ))) %>% mutate(
  LocalCode = factor(case_when(
  loc %in% "Bjarne" ~ "BJ",
  str_detect(loc, "Mosvatnet") ~ "MO", 
  str_detect(loc, "(GR)") ~ "GR", 
  str_detect(loc, "Hornesvatnet") ~ "HO", 
  str_detect(loc, "Kjosavik") ~ "KJ",
  str_detect(loc, "(LA)") ~ "LA", 
  str_detect(loc, "Raulemyra")  ~ "RA", 
  str_detect(loc, "Rennes") ~ "RE", 
  loc %in% "Revehamn" ~ "RH",
  str_detect(loc, "(AE)")~ "AE", 
  str_detect(BBid, "BB-LS") ~ "LS" 
    ))) %>% 
  dplyr::select(-loc) 

unique(boxdf$loc)
levels(boxdf1$Locality)
levels(boxdf1$LocalCode)
list(levels(boxdf1$Locality))

table(boxdf1$Locality)

## Now check that the location information makes sense
##

## Convert lat longs to spatial objects

boxdf2 <- st_as_sf(boxdf1, coords=c("lon", "lat"), crs = "+proj=latlong +ellps=WGS84 +datum=WGS84 +units=m +no_defs")

crs(boxdf2$geometry)

# plot(boxdf2)

mapview(boxdf2)
output_today

st_write(boxdf2, 
         "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/Noctur/Analyses/Outputs/Reed/CleanBatCaptureData2024_2025-08-26/batboxes_2025.kml", 
         driver = "KML", delete_layer = TRUE)

# Looks right!Locality# Looks right!! 
summary(boxdf2$Locality)
# 41 at Mosvatnet 

mosvatnet <- as.data.frame(boxdf1) %>% 
  dplyr::filter(Locality == "Mosvatnet") %>% 
  droplevels()

mo <- st_as_sf(mosvatnet, coords=c("lon", "lat"), crs = "+proj=latlong +ellps=WGS84 +datum=WGS84 +units=m +no_defs")

mapview(mo)
getwd()
st_write(mo, "Mosvatnet.kml") # Moved to locations folder for Noctur  bat boxes on OneDrive

# write.csv(boxdf2, filename()# write.csv(boxdf2, file = file.path(output_today, "AllBatBoxLocations_Combined.csv"))
# 07.01.2025

## Now also the same for the bat boxes at Revehavn 
revehamn <- as.data.frame(boxdf1) %>% 
  dplyr::filter(Locality == "Revehamn") %>% 
  droplevels()

rev <- st_as_sf(revehamn, coords=c("lon", "lat"), crs = "+proj=latlong +ellps=WGS84 +datum=WGS84 +units=m +no_defs")

mapview(rev)

st_write(rev, "Revehamn.kml") # Moved to locations folder for Noctur  bat boxes on OneDrive

### Quickly explore the NZF bat box locations in Agder
agder <- st_read("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/Noctur/Data/BatBoxes/Locations/ListaFarsundNZF.KML")

crs(agder) 
# GEOGCRS[\"WGS 84\   EPSG\",4326]
plot1 <- agder %>% leaflet() %>% 
   addTiles()  %>% 
   addCircleMarkers(radius = 3, color = "red", 
                       fillOpacity = 0.85,  stroke = TRUE) %>% 
  addMiniMap(
    position = "bottomright", zoomLevelOffset = -7, width = 300, height = 300, 
    collapsedWidth = 19, collapsedHeight = 19) %>% 
  addScaleBar(position = "bottomright")
plot1$x$options = append(plot1$x$options, list("zoomControl" = FALSE,  "scaleBar"=TRUE))
plot1
8+6

```


## Now combine bat capture data with the bat box location data 
```{r}
#Bid is Bat ID and BBid is Bat Box ID 
DF <- left_join(bcap3, boxdf1) %>% distinct()
# 78 obs 18 vars 

summary(DF)
# Innitially: Now we have an additional two observations... why? 
# One bat ID linked to multiple descriptions of a bat box id most likely ... 

# test <- duplicated_rows_dplyr <- DF |>
#   group_by(Bid) |>
#   filter(n() > 1) |>
#   ungroup()

## Fixed iy

## Duplicate Bids when bats are captured at the same bat box on different dates - therefore created a ubid (unique bat ID) combining Bid and Date 

 
summary(DF)

ggplot(DF) + 
  geom_bar(aes(x = BBid, fill = Locality)) + 
  scale_fill_manual(values = '
                    c("#5b859e", "#1e395f", "#75884b", "#1e5a46", 
                      "#df8d71", "#af4f2f", "#d48f90", "#732f30",
                      "#ab84a5", "#59385c", "#d8b847")) + 
  coord_flip() + 
  theme_classic() + 
  xlab("Bat box IDs") + 
  ylab("Number of bats captured") + 
  scale_y_continuous(breaks = seq(0, 10, by = 2)) 

## Looks good! Now clean the column names to make them more informative and easier to report to ArtsDatabanken

# write.csv(DF, file = file.path(output_today, "BatCaptureData_w_Locations_2024_simplecolumns.csv"))
# 08.01.2025
DF1 <- DF %>% 
  dplyr::select(c(ubid, BandNumber, Date, datetime, Crew,
                  BBid, Locality, LocalCode, 
                  lat, lon, 
                  Bid, Species, 
                  sex, Age, Repro, buccal,
                  RFA, Weight)) %>% 
  rename(UniqueBatID = ubid, 
         SpeciesCode = Species,
         DateTime = datetime, 
         BatBoxID = BBid, 
         Latitude = lat, 
         Longitude = lon, 
         BatID = Bid, 
         Sex = sex,
         Buccal = buccal) %>% 
  rename('Right forearm length (mm)' = RFA, 
         'Weight (g)' = Weight) %>% 
  mutate(Species = factor(case_when(
    SpeciesCode == "PPYG" ~ "Pipistrellus pygmaeus",
    SpeciesCode == "PNAT" ~ "Pipistrellus nathusii"
  ))) %>% 
  mutate(Date_ArtsObs = strftime(Date, format = "%Y.%m.%d"))

summary(DF1)

# write.csv(DF1, file = file.path(output_today, "BatCaptureData_w_Locations_2024_Clear_Columns.csv"))
# 08.01.2025

```


